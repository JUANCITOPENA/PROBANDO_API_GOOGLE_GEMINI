<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8">
  <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/10306/10306029.png" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi App con Gemini AI</title>
  
  <!-- CSS de Prism y sus plugins -->
  <link id="prism-theme" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.min.css" rel="stylesheet" />

  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    .perfil-ciberpunk {
  font-family: 'Orbitron', sans-serif;
  color: #00fff7;
}

/* Imagen principal */
.perfil-ciberpunk .avatar-container {
  text-align: center;
  margin-top: 40px;
}

.perfil-ciberpunk .avatar-container img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  cursor: pointer;
  border: 3px double #00fff7;
  box-shadow: 0 0 12px #00fff7;
  transition: transform 0.3s ease;
}

.perfil-ciberpunk .avatar-container img:hover {
  transform: scale(1.1);
}

/* Modal */
.perfil-ciberpunk .modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 255, 247, 0.1);
  backdrop-filter: blur(10px);
  animation: fadeIn 0.5s ease;
}

.perfil-ciberpunk .modal-content {
  background-color: #1a1a1a;
  margin: 5% auto;
  padding: 30px;
  border: 3px double #00fff7;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 0 25px #00fff7;
  border-radius: 12px;
  animation: slideUp 0.5s ease;
  text-align: center;
}

/* Imagen dentro del modal */
.perfil-ciberpunk .modal-content img {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  border: 3px double #ff00ff;
  box-shadow: 0 0 15px #ff00ff;
  margin-bottom: 20px;
}

/* T√≠tulo y texto */
.perfil-ciberpunk .modal-content h2 {
  color: #ff00ff;
  text-shadow: 0 0 6px #ff00ff;
  margin-bottom: 10px;
}

.perfil-ciberpunk .modal-content p {
  color: #ccc;
  line-height: 1.6;
  margin-bottom: 10px;
}

.perfil-ciberpunk .modal-content ul {
  list-style: none;
  padding: 0;
  margin: 10px 0;
}

.perfil-ciberpunk .modal-content ul li {
  margin: 6px 0;
  color: #00ff99;
}

/* Botonera social */
.perfil-ciberpunk .social-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
}

.perfil-ciberpunk .social-buttons a {
  text-decoration: none;
  color: #fff;
  padding: 10px 15px;
  border: 2px double #ff00ff;
  border-radius: 6px;
  background-color: #222;
  box-shadow: 0 0 10px #ff00ff;
  transition: background 0.3s ease;
}

.perfil-ciberpunk .social-buttons a:hover {
  background-color: #ff00ff;
  color: #000;
}

/* Bot√≥n cerrar */
.perfil-ciberpunk .close {
  color: #ff00ff;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  position: absolute;
  top: 20px;
  right: 30px;
}

.perfil-ciberpunk .close:hover {
  color: #fff;
}

/* Animaciones */
@keyframes fadeIn {
  from {opacity: 0;}
  to {opacity: 1;}
}

@keyframes slideUp {
  from {transform: translateY(60px);}
  to {transform: translateY(0);}
}

  </style>
</head>

<body>
  <div class="app-wrapper">
    <!-- CORRECCI√ìN: Estructura del panel del historial actualizada -->
    <aside class="history-panel" id="historyPanel">
      <div class="history-actions">
        <button id="newChatBtn" title="Iniciar un nuevo chat">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
            </svg>
            Nuevo Chat
        </button>
      </div>
      <div class="history-header">
        <h3>Historial</h3>
        <button id="clearHistoryBtn" title="Limpiar historial">üóëÔ∏è</button>
      </div>
      <div class="history-list" id="historyList"></div>
    </aside>

    <!-- CORRECCI√ìN: El bot√≥n de men√∫ ahora est√° fuera del main-content para un mejor posicionamiento -->
    <button id="menuToggle" class="menu-toggle" title="Mostrar/Ocultar Historial">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <main class="main-content" id="mainContent">
      <div class="theme-toggle-container">
        <button id="themeToggle" title="Cambiar modo claro/oscuro">üåû</button>
      </div>
      
      <div class="container">


    

 
  <!-- Imagen principal -->
  <div class="avatar-container">
    <img src="https://avatars.githubusercontent.com/u/38921558?v=4" alt="Avatar" id="openModal">
  </div>

  <!-- Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>

      <!-- Imagen centrada dentro del modal -->
      <img src="https://avatars.githubusercontent.com/u/38921558?v=4" alt="Avatar Modal">

      <h2>Juancito Pe√±a Vizca√≠no</h2>
      <p><strong>Profesi√≥n:</strong> Desarrollador Full-Stack, Analista de Datos, Tutor</p>
      <p><strong>Bio:</strong> Mentor creativo y estratega digital con pasi√≥n por transformar historias en c√°psulas educativas virales. L√≠der en branding, motivaci√≥n y desarrollo t√©cnico con impacto visual.</p>

      <ul>
        <li>Desarrollo de apps modulares</li>
        <li>Dashboards y simulaciones en Excel</li>
        <li>Producci√≥n de series educativas y motivacionales</li>
        <li>Mentor√≠a t√©cnica y narrativa</li>
      </ul>

      <div class="social-buttons">
        <a href="https://github.com/juancitopv" target="_blank">GitHub</a>
        <a href="https://linkedin.com" target="_blank">LinkedIn</a>
        <a href="https://youtube.com" target="_blank">YouTube</a>
        <a href="https://twitter.com" target="_blank">Twitter</a>
      </div>
    </div>
  


  <script>
    const modal = document.getElementById("profileModal");
    const openBtn = document.getElementById("openModal");
    const closeBtn = document.getElementById("closeModal");

    openBtn.onclick = () => modal.style.display = "block";
    closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = (event) => {
      if (event.target == modal) modal.style.display = "none";
    };
  </script>


        <h1>üõ†Ô∏è Asistente con AIüòÉüöÄ</h1>
        <!-- P√°rrafo modificado con los estilos en l√≠nea -->
          <p style="text-align: center; font-size: 1.2rem; font-weight: 600; background: linear-gradient(90deg, #4f46e5, #a855f7, #ec4899, #22d3ee); background-size: 200% 200%; -webkit-background-clip: text; background-clip: text; color: transparent; animation: ai-gradient-animation 5s ease infinite;">
            Preg√∫ntame lo que quieras. ¬°Estoy aqu√≠ para ayudarte! üöÄ
          </p>
<br>
     
        <div class="result-container">
          <div class="result-header">
            <h3>Conversaci√≥n con la IA ü§ñ:</h3>
            <div class="result-actions">
              <button id="copyBtn" title="Copiar toda la conversaci√≥n" class="flurente-button" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                    <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                    <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                </svg>
                <span class="copy-text">‚ú® Copiar Todo</span>
              </button>
              <div class="dropdown" id="downloadDropdown">
                <button id="saveBtn" class="flurente-green-button dropdown-toggle" title="Guardar como..." disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/>
                </svg>
                <span class="save-text">‚ú® Guardar</span>
                </button>
                <div class="dropdown-menu" id="downloadOptions">
                  <a href="#" id="saveTxtBtn">Guardar como .txt</a>
                  <a href="#" id="saveCsvBtn">Guardar como .csv</a>
                  <a href="#" id="saveXlsxBtn">Guardar como .xlsx</a>
                </div>
              </div>
            </div>
          </div>
          <div id="resultBox" class="result-box">Esperando consulta...</div>
        </div>
<br>
        <div class="prompt-container">
            <textarea class="prompt-area" id="promptInput" placeholder="Escribe tu consulta o usa el micr√≥fono..." rows="1"></textarea>
            <button id="micBtn" class="mic-btn" title="Activar micr√≥fono">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic-fill" viewBox="0 0 16 16">
                <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
              </svg>
            </button>
          </div>

<div class="prompt-section">
          
          <br>
          <div class="button-group">
            <button id="executeBtn" title="Enviar consulta">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/></svg>
              Enviar
            </button>
            <button id="clearBtn" title="Limpiar consulta actual">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eraser" viewBox="0 0 16 16"><path d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828zm2.121.707a1 1 0 0 0-1.414 0L4.16 7.547l5.293 5.293 4.633-4.633a1 1 0 0 0 0-1.414zM8.746 13.547 3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293z"/></svg>
              Limpiar
            </button>
          </div>
        </div>

      </div>

         

    </main>
  </div>
  

  <div class="loading" id="loading" style="display: none;">
    <div class="spinner"></div>
    <span>Cargando...</span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  

   <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- ‚úÖ CORRECCI√ìN: Se usa Autoloader para cargar din√°micamente CUALQUIER lenguaje que la IA genere -->
  <!-- Esto es m√°s flexible que pre-cargar una lista fija -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>


  
  
  <!-- Scripts de Prism y Plugins (M√©todo robusto) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

  <!-- ... (El resto de tu HTML termina aqu√≠, justo antes de los scripts) ... -->

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- ‚úÖ CORRECCI√ìN: Se usa Autoloader para cargar din√°micamente CUALQUIER lenguaje que la IA genere -->
  <!-- Esto es m√°s flexible que pre-cargar una lista fija -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

  <!-- Plugins que dependen de Prism Core -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
  
  <!-- Tu c√≥digo JavaScript de la aplicaci√≥n -->
  <script>
    // --- Referencias a elementos del DOM ---
    const executeBtn = document.getElementById('executeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const promptInput = document.getElementById('promptInput');
    const resultBox = document.getElementById('resultBox');
    const loadingIndicator = document.getElementById('loading');
    const copyBtn = document.getElementById('copyBtn');
    const saveBtn = document.getElementById('saveBtn');
    const themeToggleBtn = document.getElementById('themeToggle');
    const menuToggle = document.getElementById('menuToggle');
    const historyPanel = document.getElementById('historyPanel');
    const historyList = document.getElementById('historyList');
    const mainContent = document.getElementById('mainContent');
    const downloadDropdown = document.getElementById('downloadDropdown');
    const saveTxtBtn = document.getElementById('saveTxtBtn');
    const saveCsvBtn = document.getElementById('saveCsvBtn');
    const saveXlsxBtn = document.getElementById('saveXlsxBtn');
    const micBtn = document.getElementById('micBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');

    let currentChatHistory = [];

    // --- L√≥gica de Reconocimiento de Voz ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'es-ES';
        recognition.interimResults = false;
        micBtn.addEventListener('click', () => {
            micBtn.classList.contains('is-listening') ? recognition.stop() : recognition.start();
        });
        recognition.onstart = () => { micBtn.classList.add('is-listening'); promptInput.placeholder = "Escuchando..."; };
        recognition.onend = () => { micBtn.classList.remove('is-listening'); promptInput.placeholder = "Escribe tu consulta o usa el micr√≥fono..."; };
        recognition.onerror = (event) => { console.error('Error en reconocimiento de voz:', event.error); showNotification(`Error de micr√≥fono: ${event.error}`); };
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            promptInput.value += (promptInput.value ? ' ' : '') + transcript;
            promptInput.dispatchEvent(new Event('input'));
        };
    } else {
        micBtn.style.display = 'none';
    }
    
    // --- L√≥gica de la Interfaz (UI) ---
    themeToggleBtn.addEventListener('click', () => {
        let targetTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', targetTheme);
        localStorage.setItem('theme', targetTheme);
        themeToggleBtn.textContent = targetTheme === 'light' ? 'üåû' : 'üåú';
        updatePrismTheme(targetTheme);
    });
    function updatePrismTheme(theme) {
        const prismLink = document.getElementById('prism-theme');
        if (prismLink) {
            prismLink.href = theme === 'dark'
              ? 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css'
              : 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css';
        }
    }
    menuToggle.addEventListener('click', () => {
        historyPanel.classList.toggle('open');
        mainContent.classList.toggle('history-open');
    });
    promptInput.addEventListener('input', () => {
        promptInput.style.height = 'auto';
        promptInput.style.height = (promptInput.scrollHeight) + 'px';
    });
    promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            executeBtn.click();
        }
    });
    clearHistoryBtn.addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro de que quieres borrar todo el historial?')) {
            localStorage.removeItem('chatHistory');
            loadHistory();
            startNewChat();
        }
    });

    // --- L√≥gica del Historial (localStorage) ---
    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('chatHistory')) || [];
        historyList.innerHTML = '';
        if (history.length === 0) {
            historyList.innerHTML = '<div class="history-empty">No hay chats guardados.</div>';
            return;
        }

        history.forEach((item) => {
            if (!item || !item.messages || item.messages.length === 0) return;
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const firstUserMessage = item.messages.find(m => m.role === 'user');
            if (!firstUserMessage) return;

            let title = firstUserMessage.parts[0].text;
            const instructionMarker = "--- MI PRIMERA PREGUNTA:";
            if (title.includes(instructionMarker)) {
                title = title.split(instructionMarker)[1].trim();
            }

            const promptText = title.substring(0, 25) + (title.length > 25 ? '...' : '');
            historyItem.innerHTML = `<div class="history-prompt">${promptText}</div>`;

            historyItem.addEventListener('click', () => {
                loadChatFromHistory(item.id);
                if (window.innerWidth <= 768) {
                    historyPanel.classList.remove('open');
                    mainContent.classList.remove('history-open');
                }
            });
            historyList.appendChild(historyItem);
        });
    }

    function saveChatToHistory() {
        if (currentChatHistory.length === 0) return;
        let history = JSON.parse(localStorage.getItem('chatHistory')) || [];
        const chatId = currentChatHistory.find(m => m.id)?.id || Date.now();
        const chatData = { id: chatId, messages: currentChatHistory, timestamp: Date.now() };

        const existingChatIndex = history.findIndex(chat => chat && chat.id === chatId);
        if (existingChatIndex > -1) {
            history[existingChatIndex] = chatData;
        } else {
            history.unshift(chatData);
        }
        if (history.length > 50) history.pop();
        localStorage.setItem('chatHistory', JSON.stringify(history));
        loadHistory();
    }

    function loadChatFromHistory(chatId) {
        let history = JSON.parse(localStorage.getItem('chatHistory')) || [];
        const chatToLoad = history.find(chat => chat && chat.id === chatId);
        if (chatToLoad) {
            currentChatHistory = chatToLoad.messages;
            resultBox.innerHTML = '';
            
            currentChatHistory.forEach(message => {
                if (message.role === 'user' || message.role === 'model') {
                    let content = message.parts[0].text;
                    const instructionMarker = "--- MI PRIMERA PREGUNTA:";
                    if (content.includes(instructionMarker)) {
                        content = content.split(instructionMarker)[1].trim();
                    }
                    appendMessageToResultBox(message.role, content, false);
                }
            });
            // ‚úÖ CORRECCI√ìN: Usar Prism.highlightAll() despu√©s de a√±adir todo el contenido
            Prism.highlightAll();
            setUIState(false);
        }
    }


    // --- L√≥gica Principal de la App ---
    executeBtn.addEventListener('click', executeQuery);
    clearBtn.addEventListener('click', clearPromptInput);
    newChatBtn.addEventListener('click', startNewChat);

    async function executeQuery() {
        const userPrompt = promptInput.value.trim();
        if (!userPrompt) {
            showNotification('Por favor, escribe una consulta.');
            return;
        }

        let promptForApi = userPrompt;
        
        if (currentChatHistory.length === 0) {
            const systemInstructionText = `
                Eres un asistente experto. Formatea tus respuestas de la siguiente manera:
                1. C√ìDIGO: Usa siempre bloques de c√≥digo Markdown con el nombre del lenguaje (ej: \`\`\`javascript, \`\`\`python, \`\`\`sql).
                2. TEXTO: Usa Markdown para estructurar (t√≠tulos ##, subt√≠tulos ###, listas *, negritas **). Usa emojis sutiles (‚úÖ, üí°, ‚ö†Ô∏è).
                --- MI PRIMERA PREGUNTA:
            `;
            promptForApi = systemInstructionText + "\n" + userPrompt;
            currentChatHistory.push({ id: Date.now(), role: 'user', parts: [{ text: promptForApi }] });
        } else {
            currentChatHistory.push({ role: 'user', parts: [{ text: promptForApi }] });
        }
        
        appendMessageToResultBox('user', userPrompt);
        promptInput.value = ''; 
        promptInput.style.height = 'auto';
        setUIState(true);

        try {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: currentChatHistory.map(({id, ...rest}) => rest) }),
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `Error ${response.status}`);
            
            const modelResponseParts = data.candidates?.[0]?.content?.parts;
            if (modelResponseParts && modelResponseParts.length > 0) {
                const responseText = modelResponseParts.map(p => p.text).join('');
                currentChatHistory.push({ role: 'model', parts: [{ text: responseText }] });
                appendMessageToResultBox('model', responseText);
                saveChatToHistory();
            } else {
                throw new Error("El modelo no devolvi√≥ contenido v√°lido.");
            }
        } catch (error) {
            console.error('Error en executeQuery:', error);
            appendMessageToResultBox('error', `Error: ${error.message}`);
        } finally {
            setUIState(false);
        }
    }

    function appendMessageToResultBox(role, content, highlight = true) {
        if (resultBox.innerHTML.includes('Esperando consulta...')) {
            resultBox.innerHTML = '';
        }
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}-message`;
        if (role === 'error') messageDiv.classList.add('error-message-display');
        const timestamp = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
        const headerText = role === 'user' ? 'T√∫' : (role === 'model' ? 'IA' : 'Error');
        const formattedContent = marked.parse(content);
        messageDiv.innerHTML = `
            <div class="message-header"><strong>${headerText}</strong> <span class="timestamp">${timestamp}</span></div>
            <div class="message-content">${formattedContent}</div>`;
        resultBox.appendChild(messageDiv);
        
        if (highlight) {
            // ‚úÖ CORRECCI√ìN: Usar Prism.highlightAll() que funciona mejor con el autoloader
            Prism.highlightAll();
        }
        
        resultBox.scrollTop = resultBox.scrollHeight;
    }

    // --- Funciones de Utilidad (sin cambios) ---
    copyBtn.addEventListener('click', () => copyToClipboard(resultBox.innerText));
    saveTxtBtn.addEventListener('click', (e) => { e.preventDefault(); saveAsTextFile(); });
    saveCsvBtn.addEventListener('click', (e) => { e.preventDefault(); saveAsCsvFile(); });
    saveXlsxBtn.addEventListener('click', (e) => { e.preventDefault(); saveAsXlsxFile(); });
    async function copyToClipboard(textToCopy) {
        if (!textToCopy || resultBox.textContent === 'Esperando consulta...') return showNotification('No hay nada que copiar.');
        try {
            await navigator.clipboard.writeText(textToCopy);
            const copyTextSpan = copyBtn.querySelector('.copy-text');
            const originalText = copyTextSpan.textContent;
            copyTextSpan.textContent = '¬°Copiado!';
            copyBtn.disabled = true;
            setTimeout(() => { copyTextSpan.textContent = originalText; copyBtn.disabled = false; }, 1500);
        } catch (err) {
            console.error('Error al copiar:', err);
            showNotification('No se pudo copiar el texto.');
        }
    }
    function saveAsTextFile() { const textToSave = resultBox.innerText; if (!textToSave || textToSave === 'Esperando consulta...') return; triggerDownload(new Blob([textToSave], { type: 'text/plain;charset=utf-8' }), 'gemini-conversacion.txt'); }
    function saveAsCsvFile() { const tables = resultBox.querySelectorAll('table'); if (tables.length === 0) return showNotification('No se encontr√≥ una tabla para exportar a CSV.'); const table = tables[tables.length - 1]; let csv = []; table.querySelectorAll('tr').forEach(row => { let rowData = []; row.querySelectorAll('th, td').forEach(cell => rowData.push(`"${cell.innerText.replace(/"/g, '""')}"`)); csv.push(rowData.join(',')); }); triggerDownload(new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' }), 'gemini-tabla.csv'); }
    function saveAsXlsxFile() { const tables = resultBox.querySelectorAll('table'); if (tables.length === 0) return showNotification('No se encontr√≥ una tabla para exportar a XLSX.'); const table = tables[tables.length - 1]; const wb = XLSX.utils.table_to_book(table); XLSX.writeFile(wb, 'gemini-tabla.xlsx'); }
    function triggerDownload(blob, filename) { const url = URL.createObjectURL(blob); const anchor = document.createElement('a'); anchor.href = url; anchor.download = filename; document.body.appendChild(anchor); anchor.click(); document.body.removeChild(anchor); URL.revokeObjectURL(url); }
    function setUIState(isLoading) { loadingIndicator.style.display = isLoading ? 'flex' : 'none'; executeBtn.disabled = isLoading; clearBtn.disabled = isLoading; newChatBtn.disabled = isLoading; micBtn.disabled = isLoading; const hasContent = resultBox.textContent !== 'Esperando consulta...' && resultBox.innerHTML.trim() !== ''; copyBtn.disabled = isLoading || !hasContent; saveBtn.disabled = isLoading || !hasContent; downloadDropdown.toggleAttribute('disabled', isLoading || !hasContent); }
    function clearPromptInput() { promptInput.value = ''; promptInput.style.height = 'auto'; promptInput.focus(); }
    function startNewChat() { currentChatHistory = []; promptInput.value = ''; resultBox.innerHTML = 'Esperando consulta...'; promptInput.style.height = 'auto'; setUIState(false); }
    function showNotification(message) { alert(message); }

    // --- Carga Inicial ---
    document.addEventListener('DOMContentLoaded', () => {
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
      themeToggleBtn.textContent = theme === 'light' ? 'üåû' : 'üåú';
      updatePrismTheme(theme);
      loadHistory();
      startNewChat();
    });
  </script>
</body>
</html>



